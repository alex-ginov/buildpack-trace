#!/bin/bash
set -e

APP_DIR="/app"
CONFIG_FILE="${APP_DIR}/config/tempo.yaml"

echo "===== STARTING TEMPO ====="
echo "PORT: ${PORT}" # Variable d'environnement fournie par Scalingo

# 1. Vérification des fichiers
if [ ! -x "${APP_DIR}/bin/tempo" ]; then
  echo "Error: Tempo binary not found or not executable!" >&2
  exit 1
fi
if [ ! -f "${CONFIG_FILE}" ]; then
  echo "Error: Configuration file ${CONFIG_FILE} not found!" >&2
  exit 1
fi

# 2. Créer les répertoires de stockage (obligatoire pour le backend local)
mkdir -p "${APP_DIR}/storage/wal"
mkdir -p "${APP_DIR}/storage/blocks"
echo "Storage directories created/verified in /app/storage"

# 3. Lancer Tempo
echo "-----> Launching Tempo..."
# 'exec' est utilisé pour remplacer le shell actuel par le processus Tempo, ce qui est la bonne pratique Heroku/Scalingo
exec "${APP_DIR}/bin/tempo" --config.file="${CONFIG_FILE}" --server.http-listen-port="${PORT}"