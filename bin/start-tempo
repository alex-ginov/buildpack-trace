#!/bin/bash
set -e

echo "===== ENVIRONMENT DEBUG ====="
echo "PORT: ${PORT}"
echo "PWD: $(pwd)"

echo "===== DIRECTORY STRUCTURE ====="
ls -la /app/ || echo "Cannot list /app"
ls -la /app/bin/ || echo "Cannot list /app/bin"

echo "===== TEMPO BINARY CHECK ====="
if [ -f "/app/bin/tempo" ]; then
    echo "✓ Tempo binary found"
    file /app/bin/tempo
    /app/bin/tempo --version || echo "Cannot get version"
else
    echo "✗ Tempo binary NOT FOUND in /app/bin/tempo"
    exit 1
fi

echo "===== CONFIGURATION CHECK ====="
if [ -f "/app/config/tempo.yaml" ]; then
    echo "✓ Config file found"
else
    echo "✗ Config file NOT FOUND"
    exit 1
fi

echo "===== STORAGE DIRECTORIES ====="
mkdir -p /app/storage/wal
mkdir -p /app/storage/blocks
echo "Storage directories created"

echo "===== STARTING TEMPO ====="
echo "Starting Tempo on port: ${PORT}"

# Démarrer Tempo avec le port dynamique passé en argument
exec /app/bin/tempo \
  -config.file=/app/config/tempo.yaml \
  -server.http-listen-port=${PORT}