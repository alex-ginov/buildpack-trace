#!/bin/bash
set -e

BUILD_DIR=$1
CACHE_DIR=$2
BUILDPACK_DIR="$(cd -P "$(dirname "$0")/.." && pwd)"

TEMPO_VERSION="2.4.0" # Version de Tempo à installer

echo "-----> Installing Tempo v${TEMPO_VERSION}"

# 1. Définir l'URL de téléchargement
TEMPO_ARCHIVE="tempo_${TEMPO_VERSION}_linux_amd64.tar.gz"
TEMPO_URL="https://github.com/grafana/tempo/releases/download/v${TEMPO_VERSION}/${TEMPO_ARCHIVE}"

# Créer les répertoires nécessaires
mkdir -p "$BUILD_DIR/bin"
mkdir -p "$BUILD_DIR/config"
mkdir -p "/tmp/tempo-extract"

# 2. Télécharger et extraire
echo "-----> Downloading Tempo from: $TEMPO_URL"
curl -L --silent --show-error --retry 3 --fail -o "/tmp/$TEMPO_ARCHIVE" "$TEMPO_URL" || \
    (echo "Error downloading Tempo" && exit 1)

echo "-----> Extracting Tempo to /tmp/tempo-extract"
tar -xzf "/tmp/$TEMPO_ARCHIVE" -C "/tmp/tempo-extract"

# 3. Copier les binaires et rendre exécutables
echo "-----> Installing binaries and scripts"
cp /tmp/tempo-extract/tempo "$BUILD_DIR/bin/"
chmod +x "$BUILD_DIR/bin/tempo"

# Copier le script de démarrage depuis le buildpack
cp "$BUILDPACK_DIR/bin/start-tempo" "$BUILD_DIR/bin/"
chmod +x "$BUILD_DIR/bin/start-tempo"

# 4. Copier la configuration par défaut
if [ -f "$BUILDPACK_DIR/config/tempo.yaml" ]; then
  cp "$BUILDPACK_DIR/config/tempo.yaml" "$BUILD_DIR/config/"
fi

# Nettoyage
rm -rf /tmp/tempo-extract
rm -f "/tmp/$TEMPO_ARCHIVE"

echo "-----> Tempo v${TEMPO_VERSION} installed successfully."